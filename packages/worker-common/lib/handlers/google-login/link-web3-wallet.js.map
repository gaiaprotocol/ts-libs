{"version":3,"file":"link-web3-wallet.js","sourceRoot":"","sources":["../../../src/handlers/google-login/link-web3-wallet.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,UAAU,EAAE,MAAM,MAAM,CAAC;AAClC,OAAO,EAAE,WAAW,EAAE,MAAM,oBAAoB,CAAC;AACjD,OAAO,EAAE,WAAW,EAAE,MAAM,SAAS,CAAC;AAEtC,MAAM,CAAC,KAAK,UAAU,0BAA0B,CAC9C,OAAgB,EAChB,GAAkE;IAElE,IAAI,CAAC;QACH,MAAM,IAAI,GAAG,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC;QAClD,IAAI,CAAC,IAAI,EAAE,UAAU,CAAC,SAAS,CAAC,EAAE,CAAC;YACjC,OAAO,IAAI,QAAQ,CAAC,cAAc,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC,CAAC;QACvD,CAAC;QAED,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;QAC5B,MAAM,OAAO,GAAG,MAAM,WAAW,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;QAC9C,IAAI,CAAC,OAAO,EAAE,GAAG,EAAE,CAAC;YAClB,OAAO,IAAI,QAAQ,CAAC,cAAc,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC,CAAC;QACvD,CAAC;QAED,MAAM,iBAAiB,GAAG,UAAU,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;QAElD,MAAM,EAAE,GAAG,MAAM,WAAW,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;QAC3C,IAAI,CAAC,EAAE,EAAE,GAAG,EAAE,CAAC;YACb,OAAO,QAAQ,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,eAAe,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC,CAAC;QACpE,CAAC;QAED,2CAA2C;QAC3C,MAAM,GAAG,CAAC,EAAE,CAAC,OAAO,CAClB;+CACyC,CAC1C;aACE,IAAI,CAAC,iBAAiB,CAAC;aACvB,GAAG,EAAE,CAAC;QAET,MAAM,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC;QAC1C,MAAM,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC;;;;;;;;;;;KAWpB,CAAC;aACC,IAAI,CACH,EAAE,CAAC,GAAG,EACN,iBAAiB,EACjB,KAAK,EACL,GAAG,EACH,EAAE,CAAC,KAAK,IAAI,IAAI,EAChB,EAAE,CAAC,IAAI,IAAI,IAAI,EACf,EAAE,CAAC,OAAO,IAAI,IAAI,CACnB;aACA,GAAG,EAAE,CAAC;QAET,OAAO,QAAQ,CAAC,IAAI,CAAC;YACnB,EAAE,EAAE,IAAI;YACR,cAAc,EAAE,iBAAiB;YACjC,KAAK;YACL,OAAO,EAAE;gBACP,GAAG,EAAE,EAAE,CAAC,GAAG;gBACX,KAAK,EAAE,EAAE,CAAC,KAAK,IAAI,IAAI;gBACvB,IAAI,EAAE,EAAE,CAAC,IAAI,IAAI,IAAI;gBACrB,OAAO,EAAE,EAAE,CAAC,OAAO,IAAI,IAAI;aAC5B;YACD,SAAS,EAAE,GAAG;SACf,CAAC,CAAC;IACL,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QACnB,OAAO,QAAQ,CAAC,IAAI,CAClB,EAAE,KAAK,EAAE,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,EAC3D,EAAE,MAAM,EAAE,GAAG,EAAE,CAChB,CAAC;IACJ,CAAC;AACH,CAAC","sourcesContent":["import { D1Database } from '@cloudflare/workers-types';\nimport { getAddress } from 'viem';\nimport { verifyToken } from '../../services/jwt';\nimport { readSession } from './utils';\n\nexport async function handleLinkGoogleWeb3Wallet(\n  request: Request,\n  env: { DB: D1Database, JWT_SECRET: string, COOKIE_SECRET: string }\n): Promise<Response> {\n  try {\n    const auth = request.headers.get('authorization');\n    if (!auth?.startsWith('Bearer ')) {\n      return new Response('Unauthorized', { status: 401 });\n    }\n\n    const token = auth.slice(7);\n    const payload = await verifyToken(token, env);\n    if (!payload?.sub) {\n      return new Response('Unauthorized', { status: 401 });\n    }\n\n    const normalizedAddress = getAddress(payload.sub);\n\n    const me = await readSession(env, request);\n    if (!me?.sub) {\n      return Response.json({ error: 'not_logged_in' }, { status: 401 });\n    }\n\n    // 0) 선제 정리: 동일 지갑 주소로 기존에 연결된 다른 계정 있으면 삭제\n    await env.DB.prepare(\n      `DELETE FROM google_web3_accounts\n        WHERE LOWER(wallet_address) = LOWER(?)`\n    )\n      .bind(normalizedAddress)\n      .run();\n\n    const now = Math.floor(Date.now() / 1000);\n    await env.DB.prepare(`\n      INSERT INTO google_web3_accounts\n        (google_sub, wallet_address, token, linked_at, email, name, picture)\n      VALUES (?, ?, ?, ?, ?, ?, ?)\n      ON CONFLICT(google_sub) DO UPDATE SET\n        wallet_address = excluded.wallet_address,\n        token          = excluded.token,\n        linked_at      = excluded.linked_at,\n        email          = excluded.email,\n        name           = excluded.name,\n        picture        = excluded.picture\n    `)\n      .bind(\n        me.sub,\n        normalizedAddress,\n        token,\n        now,\n        me.email ?? null,\n        me.name ?? null,\n        me.picture ?? null,\n      )\n      .run();\n\n    return Response.json({\n      ok: true,\n      wallet_address: normalizedAddress,\n      token,\n      profile: {\n        sub: me.sub,\n        email: me.email ?? null,\n        name: me.name ?? null,\n        picture: me.picture ?? null,\n      },\n      linked_at: now,\n    });\n  } catch (err) {\n    console.error(err);\n    return Response.json(\n      { error: err instanceof Error ? err.message : String(err) },\n      { status: 500 },\n    );\n  }\n}\n"]}