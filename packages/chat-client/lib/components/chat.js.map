{"version":3,"file":"chat.js","sourceRoot":"","sources":["../../src/components/chat.ts"],"names":[],"mappings":"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","sourcesContent":["import { createAddressAvatar, createJazzicon, shortenAddress, tokenManager } from '@gaiaprotocol/client-common';\nimport '@shoelace-style/shoelace';\nimport { el } from '@webtaku/el';\nimport { getAddress } from 'viem';\nimport '../../src/components/chat.css';\nimport { ChatMessage, ChatService } from '../services/chat';\nimport { ChatProfile, chatProfileService } from '../services/chat-profile';\nimport { Attachment } from '../types/chat';\nimport { parseTextWithLinks } from '../utils/text';\nimport { Component } from './component';\n\ndeclare const API_BASE_URI: string;\n\ninterface Options {\n  roomId: string;\n  myAccount: string;\n  useAddressAvatar?: boolean;\n  /** 아바타/이름 클릭 시 호출됩니다. (키보드 Enter/Space 포함) */\n  onProfileClick?: (account: `0x${string}`, profile: ChatProfile, ev?: Event) => void;\n}\n\n/** 모든 하위 img가 로드되면 resolve */\nasync function waitForImages(node: HTMLElement) {\n  const imgs = Array.from(node.querySelectorAll('img')) as HTMLImageElement[];\n  if (!imgs.length) return;\n  await Promise.all(\n    imgs.map((img) => {\n      if (img.complete) return Promise.resolve();\n      return new Promise<void>((resolve) => {\n        const done = () => {\n          img.removeEventListener('load', done);\n          img.removeEventListener('error', done);\n          resolve();\n        };\n        img.addEventListener('load', done, { once: true });\n        img.addEventListener('error', done, { once: true });\n      });\n    })\n  );\n}\n\n/** 이미지 실패 시 대체 UI */\nfunction replaceWithFallback(img: HTMLImageElement) {\n  const wrapper = el('div.img-fallback');\n  wrapper.style.width = '180px';\n  wrapper.style.height = '120px';\n  wrapper.style.display = 'flex';\n  wrapper.style.flexDirection = 'column';\n  wrapper.style.justifyContent = 'center';\n  wrapper.style.alignItems = 'center';\n  wrapper.style.border = '1px solid var(--sl-color-neutral-200)';\n  wrapper.style.borderRadius = '8px';\n  wrapper.style.boxSizing = 'border-box';\n\n  const icon = el('sl-icon', { name: 'image' });\n  icon.style.fontSize = '48px';\n  icon.style.color = 'var(--sl-color-neutral-500)';\n\n  const msg = el('div', '불러올 수 없음');\n  msg.style.fontSize = '12px';\n  msg.style.color = 'var(--sl-color-neutral-600)';\n\n  wrapper.append(icon, msg);\n  img.replaceWith(wrapper);\n}\n\n/** 클릭 + Enter/Space 접근성 액티베이터 */\nfunction makeActivatable(elm: HTMLElement, onActivate: (ev: Event) => void) {\n  elm.style.cursor = 'pointer';\n  elm.setAttribute('role', 'button');\n  elm.setAttribute('tabindex', '0');\n\n  const handler = (ev: Event) => onActivate(ev);\n  elm.addEventListener('click', handler);\n\n  elm.addEventListener('keydown', (e: KeyboardEvent) => {\n    if (e.key === 'Enter' || e.key === ' ') {\n      e.preventDefault();\n      onActivate(e);\n    }\n  });\n}\n\nfunction createChatComponent({\n  roomId,\n  myAccount,\n  useAddressAvatar,\n  onProfileClick\n}: Options): Component & {\n  scrollToBottom: () => void;\n} {\n  // 상태\n  const pendingAttachments: { file: File; blobUrl: string }[] = [];\n  const observedAccounts = new Set<string>();\n  let autoStick = true; // 사용자가 바닥 근처일 때만 자동 스크롤 유지\n\n  // 루트/서브 요소\n  const root = el('div.chat-component');\n  const list = el('div.message-list');\n  const input = el('sl-input', { placeholder: 'Type a message…', pill: true });\n  const sendBtn = el('sl-button', { variant: 'primary', pill: true }, 'Send');\n  const attachBtn = el('sl-button', { variant: 'default', circle: true }, el('sl-icon', { name: 'paperclip' }));\n  const fileInput = el('input', { type: 'file', accept: 'image/*', multiple: true, style: 'display:none' }) as HTMLInputElement;\n  const composer = el('div.composer', input, fileInput, attachBtn, sendBtn);\n  const thumbBar = el('div.thumb-bar');\n\n  root.append(list, thumbBar, composer);\n\n  // 서비스\n  const service = new ChatService(roomId);\n  service.connect();\n\n  // ===== 유틸 =====\n  const ensureProfile = (account: string) => {\n    if (!chatProfileService.getCached(account)) {\n      chatProfileService.preload([account]);\n    }\n  };\n\n  function isNearBottom(el: HTMLElement, threshold = 24) {\n    return el.scrollHeight - el.scrollTop - el.clientHeight <= threshold;\n  }\n\n  function scrollToBottom() {\n    list.scrollTop = list.scrollHeight;\n  }\n\n  /** DOM 부착 후 “두 번의 rAF”로 레이아웃 확정 뒤 스크롤 */\n  function rafScrollToBottom() {\n    requestAnimationFrame(() => {\n      requestAnimationFrame(() => scrollToBottom());\n    });\n  }\n\n  function buildNode(msg: ChatMessage, pending = false): HTMLElement {\n    const account = getAddress(msg.account);\n    ensureProfile(account);\n\n    const wrapper = el('div.message', {\n      className: `${pending ? 'pending' : ''} ${account === myAccount ? 'own' : ''}`.trim(),\n      dataset: { id: String(msg.id ?? '') }\n    });\n\n    // 아바타\n    const avatarContainer = el('div.avatar-container', {\n      style: `\n        width:40px;\n        height:40px;\n        background-size: cover;\n        background-position: center;\n        border-radius: 50%;\n      `\n    }) as HTMLElement;\n\n    const cachedProfile = chatProfileService.getCached(account);\n    const cachedProfileImage = cachedProfile?.profileImage;\n\n    if (cachedProfileImage) {\n      avatarContainer.style.backgroundImage = `url(\"${cachedProfileImage}\")`;\n    } else {\n      const avatar = useAddressAvatar ? createAddressAvatar(account) : createJazzicon(account);\n      avatar.classList.add('avatar');\n      avatarContainer.append(avatar);\n    }\n\n    // 메타\n    const cachedName = cachedProfile?.nickname || shortenAddress(account);\n    const time = new Date(msg.timestamp).toLocaleTimeString();\n    const nameEl = el('span.name', { dataset: { account } }, cachedName) as HTMLSpanElement;\n    const meta = el('div.meta', nameEl, el('time.time', time));\n\n    // === 프로필 클릭 핸들러 연결 (옵션 제공 시만) ===\n    if (typeof onProfileClick === 'function') {\n      const activator = (ev: Event) => onProfileClick!(account as `0x${string}`, chatProfileService.getCached(account) ?? {\n        nickname: cachedName,\n        fetchedAt: Date.now(),\n      }, ev);\n      makeActivatable(avatarContainer, activator);\n      makeActivatable(nameEl, activator);\n    }\n    // ================================================\n\n    // 본문\n    const body = el('div.msg-body', meta);\n\n    if (msg.text) {\n      const textNode = el('div.text');\n      textNode.append(parseTextWithLinks(msg.text));\n      body.append(textNode);\n    }\n\n    if (msg.attachments?.length) {\n      const gallery = el(\n        'div.attachments',\n        ...msg.attachments\n          .filter((a) => a.kind === 'image')\n          .map((attachment) => {\n            const a = el('a', { href: attachment.url, target: '_blank' });\n            const img = el('img.img-msg', { alt: 'image' }) as HTMLImageElement;\n\n            // 로딩 전 임시 상태 class (CSS에서 skeleton 등 처리)\n            img.classList.add('img-loading');\n            img.src = attachment.url;\n\n            if (img.complete) {\n              img.classList.remove('img-loading');\n            } else {\n              img.onload = () => img.classList.remove('img-loading');\n              img.onerror = () => replaceWithFallback(img);\n            }\n\n            a.append(img);\n            return a;\n          })\n      );\n      body.append(gallery);\n    }\n\n    wrapper.append(avatarContainer, body);\n    return wrapper;\n  }\n\n  function renderOptimistic(text: string, attachments: Attachment[], localId: string) {\n    const temp: ChatMessage = {\n      id: -1,\n      localId,\n      type: 'chat',\n      account: myAccount,\n      text,\n      attachments,\n      timestamp: Date.now()\n    };\n    const node = buildNode(temp, true);\n    node.dataset.localId = localId;\n    list.append(node);\n\n    // 이미지 로딩 완료 후 스크롤 (바닥 근접 시만)\n    waitForImages(node).then(() => {\n      if (autoStick) scrollToBottom();\n    });\n\n    return node;\n  }\n\n  function overwritePlaceholder(placeholder: HTMLElement, real: ChatMessage) {\n    placeholder.replaceWith(buildNode(real));\n  }\n\n  function markFailed(node: HTMLElement) {\n    node.classList.remove('pending');\n    node.classList.add('failed');\n  }\n\n  // ===== 이벤트 바인딩 =====\n\n  // 프로필 변경 시 UI 반영\n  chatProfileService.addEventListener('chatprofilechange', (e) => {\n    const { account, profile } = (e as CustomEvent<{ account: `0x${string}`; profile: ChatProfile }>).detail;\n\n    list.querySelectorAll<HTMLElement>(`.message .name[data-account=\"${account}\"]`).forEach((node) => {\n      node.textContent = profile.nickname ?? shortenAddress(account);\n\n      const messageEl = node.closest('.message');\n      const avatarContainer = messageEl?.querySelector<HTMLElement>('.avatar-container') ?? null;\n\n      if (avatarContainer) {\n        if (profile.profileImage) {\n          avatarContainer.style.backgroundImage = `url(\"${profile.profileImage}\")`;\n          avatarContainer.innerHTML = '';\n        } else {\n          if (!avatarContainer.querySelector('.avatar')) {\n            const fallback = useAddressAvatar ? createAddressAvatar(account) : createJazzicon(account);\n            fallback.classList.add('avatar');\n            avatarContainer.innerHTML = '';\n            avatarContainer.append(fallback);\n          }\n          avatarContainer.style.backgroundImage = '';\n        }\n      }\n    });\n  });\n\n  // 파일 첨부\n  function pushThumb(file: File, blobUrl: string) {\n    const wrapper = el('div.thumb-wrapper');\n    const img = el('img.thumb', { src: blobUrl });\n    const removeBtn = el('button.remove', '×');\n\n    removeBtn.onclick = () => {\n      const idx = pendingAttachments.findIndex((p) => p.blobUrl === blobUrl);\n      if (idx >= 0) {\n        URL.revokeObjectURL(pendingAttachments[idx].blobUrl);\n        pendingAttachments.splice(idx, 1);\n      }\n      wrapper.remove();\n    };\n\n    wrapper.append(img, removeBtn);\n    thumbBar.append(wrapper);\n  }\n\n  attachBtn.onclick = () => fileInput.click();\n\n  fileInput.onchange = () => {\n    Array.from(fileInput.files || []).forEach((f) => {\n      const blobUrl = URL.createObjectURL(f);\n      pendingAttachments.push({ file: f, blobUrl });\n      pushThumb(f, blobUrl);\n    });\n    fileInput.value = '';\n  };\n\n  // 메시지 수신\n  service.addEventListener('message', (e) => {\n    const msg = (e as CustomEvent<ChatMessage>).detail;\n\n    // localId 치환\n    if (msg.account === myAccount && msg.localId) {\n      const ph = list.querySelector<HTMLElement>(`.message.pending[data-local-id=\"${msg.localId}\"]`);\n      if (ph) {\n        overwritePlaceholder(ph, msg);\n        if (autoStick) scrollToBottom();\n        return;\n      }\n    }\n\n    // 중복 가드\n    if (list.querySelector(`[data-id=\"${msg.id}\"]`)) return;\n\n    list.append(buildNode(msg));\n    waitForImages(list).then(() => {\n      if (autoStick) scrollToBottom();\n    });\n  });\n\n  // 초기 메시지\n  service.addEventListener('init', (e) => {\n    const initialMessages = (e as CustomEvent<ChatMessage[]>).detail;\n    initialMessages.forEach((msg) => {\n      observedAccounts.add(getAddress(msg.account));\n      list.append(buildNode(msg));\n    });\n    chatProfileService.preload([...observedAccounts]);\n\n    // 이미지 로딩을 기다리되, DOM 부착/레이아웃 확정 후 스크롤 보장\n    waitForImages(list)\n      .then(() => rafScrollToBottom())\n      .catch(() => rafScrollToBottom());\n\n    rafScrollToBottom()\n  });\n\n  // 전송\n  async function sendCurrentInput() {\n    const text = (input.value as string).trim();\n    if (!text && pendingAttachments.length === 0) return;\n\n    input.value = '';\n\n    // 낙관적 렌더용 임시 첨부 (blob URL)\n    const tempAttachments: Attachment[] = pendingAttachments.map((p) => ({\n      kind: 'image',\n      url: p.blobUrl\n    }));\n\n    const localId = crypto.randomUUID();\n    const placeholder = renderOptimistic(text, tempAttachments, localId);\n\n    try {\n      // 업로드\n      const uploaded: Attachment[] = await Promise.all(\n        pendingAttachments.map(async (p) => {\n          const fd = new FormData();\n          fd.append('image', p.file);\n          const res = await fetch(`${API_BASE_URI}/upload-image`, {\n            method: 'POST',\n            body: fd,\n            headers: { Authorization: `Bearer ${tokenManager.getToken()}` }\n          });\n          const { imageUrl, thumbnailUrl } = await res.json();\n          return { kind: 'image', url: imageUrl, thumb: thumbnailUrl };\n        })\n      );\n\n      // 실제 전송\n      const saved = await service.send(text, uploaded, localId);\n      overwritePlaceholder(placeholder, saved);\n      if (autoStick) scrollToBottom();\n    } catch {\n      markFailed(placeholder);\n    } finally {\n      pendingAttachments.forEach((p) => URL.revokeObjectURL(p.blobUrl));\n      pendingAttachments.length = 0;\n      thumbBar.innerHTML = '';\n    }\n  }\n\n  sendBtn.addEventListener('click', sendCurrentInput);\n\n  input.addEventListener(\n    'keydown',\n    (e: KeyboardEvent) => {\n      if (e.isComposing || e.key === 'Process') return;\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        sendCurrentInput();\n      }\n    },\n    { capture: true }\n  );\n\n  // 사용자 스크롤 시 autoStick 상태 갱신\n  list.addEventListener('scroll', () => {\n    autoStick = isNearBottom(list);\n  });\n\n  // 콘텐츠/레이아웃 변경 시 바닥 유지 (바닥 근접일 때만)\n  const ro = new ResizeObserver(() => {\n    if (autoStick) scrollToBottom();\n  });\n  ro.observe(list);\n\n  // 가상 키보드/뷰포트 변화 대응\n  const onResize = () => {\n    if (autoStick) scrollToBottom();\n  };\n  if (window.visualViewport) {\n    window.visualViewport.addEventListener('resize', onResize);\n  } else {\n    // fallback: 윈도우 리사이즈\n    window.addEventListener('resize', onResize);\n  }\n\n  // 컴포넌트 인터페이스\n  return {\n    el: root,\n    scrollToBottom,\n    remove() {\n      service.disconnect();\n      root.remove();\n      ro.disconnect();\n      if (window.visualViewport) {\n        window.visualViewport.removeEventListener('resize', onResize);\n      } else {\n        window.removeEventListener('resize', onResize);\n      }\n    }\n  };\n}\n\nexport { createChatComponent };\n"]}