{"version":3,"file":"derive.js","sourceRoot":"","sources":["../../src/utils/derive.ts"],"names":[],"mappings":"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","sourcesContent":["import { KeyToFrame } from \"../types/frame\";\nimport { NftData, PartCategory, PartItem, PartOptions } from \"../types/nft\";\nimport { isFlatKeyToFrame, isFlatPartOptions, isOneLevelKeyToFrame, isOneLevelPartOptions, isTwoLevelKeyToFrame, isTwoLevelPartOptions } from \"./guards\";\n\nexport function cloneData(data: NftData): { traits?: Record<string, string | number>; parts: Record<string, string | number> } {\n  return {\n    traits: data.traits ? { ...data.traits } : undefined,\n    parts: { ...data.parts },\n  };\n}\n\nexport function getPartCategoriesAndFrames(\n  partOptions: PartOptions,\n  keyToFrame: KeyToFrame,\n  traits?: Record<string, string | number>\n): { categories: PartCategory[]; keyToFrameFlat: Record<string, string> } {\n  const names = Object.keys(traits ?? {});\n  const c = names.length;\n\n  if (c === 0) {\n    if (!isFlatPartOptions(partOptions) || !isFlatKeyToFrame(keyToFrame)) {\n      throw new Error('Expected flat PartOptions/KeyToFrame for zero-trait catalog.');\n    }\n    return { categories: partOptions, keyToFrameFlat: keyToFrame };\n  }\n\n  if (c === 1) {\n    if (!isOneLevelPartOptions(partOptions) || !isOneLevelKeyToFrame(keyToFrame)) {\n      throw new Error('Expected one-level PartOptions/KeyToFrame for one-trait catalog.');\n    }\n    const t = names[0];\n    const v = traits![t] as any;\n    const categories = partOptions[v] ?? [];\n    const map = keyToFrame[v] ?? {};\n    return { categories, keyToFrameFlat: map };\n  }\n\n  if (c === 2) {\n    if (!isTwoLevelPartOptions(partOptions) || !isTwoLevelKeyToFrame(keyToFrame)) {\n      throw new Error('Expected two-level PartOptions/KeyToFrame for two-trait catalog.');\n    }\n    const [t1, t2] = names;\n    const v1 = traits![t1] as any;\n    const v2 = traits![t2] as any;\n\n    const categories = (partOptions[v1]?.[v2] ?? partOptions[v2]?.[v1] ?? []) as PartCategory[];\n    const map = (keyToFrame[v1]?.[v2] ?? keyToFrame[v2]?.[v1] ?? {}) as Record<string, string>;\n    return { categories, keyToFrameFlat: map };\n  }\n\n  throw new Error('Unsupported trait count (> 2).');\n}\n\nexport function buildDefaultParts(categories: PartCategory[]) {\n  const out: Record<string, string> = {};\n  for (const c of categories) {\n    const first = c.parts[0];\n    if (first) out[c.name] = first.name;\n  }\n  return out;\n}\n\nexport function partItemAvailable(part: PartItem, current: NftData): boolean {\n  if (!part.condition) return true;\n  const { part: dep, values } = part.condition as any;\n  const cur = current.parts[dep];\n  return cur != null && values.includes(cur);\n}\n\nexport function cleanData(\n  data: { traits?: Record<string, string | number>; parts: Record<string, string | number> },\n  partOptions: PartOptions,\n  keyToFrame: KeyToFrame\n) {\n  const { categories } = getPartCategoriesAndFrames(partOptions, keyToFrame, data.traits);\n  for (const cat of categories) {\n    const ok = cat.parts.some(p => partItemAvailable(p, data as NftData));\n    if (!ok) delete data.parts[cat.name];\n  }\n  return data;\n}\n"]}